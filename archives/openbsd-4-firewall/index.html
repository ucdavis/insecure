<!DOCTYPE html>
<html lang="en-us">
  <head>
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1">
    
    <title>Insecure@UC Davis  | Openbsd 4 Firewall</title>
    <meta name="HandheldFriendly" content="True">
    <meta name="MobileOptimized" content="320">

    <meta name="viewport" content="width=device-width,minimum-scale=1">
    <meta name="generator" content="Hugo 0.52" />
    
    
      <META NAME="ROBOTS" CONTENT="NOINDEX, NOFOLLOW">
    

    
    
      <link href="/dist/css/app.955516233bcafa4d2a1c13cea63c7b50.css" rel="stylesheet">
    

    

    
      
    

    

    <meta property="og:title" content="Openbsd 4 Firewall" />
<meta property="og:description" content="Create a boot disk for OpenBSD Install: On a Windows system:
Download ftp://ftp.openbsd.org/pub/OpenBSD/4.0/i386/cdemu40.iso for a bootable cd image. OR
Download ftp://ftp.openbsd.org/pub/OpenBSD/4.0/tools/ntrw.exe Download ftp://ftp.openbsd.org/pub/OpenBSD/4.0/i386/floppy40.fs for IDE install, floppyB40.fs for SCSI install and floppyC40.fs for laptop install. Insert a blank floppy and from the command prompt type:
ntrw floppy40.fs a:  Install OpenBSD: Insert CD/floppy in machine on which you want to install OpenBSD and boot system from the disk. If you&rsquo;re using a system with no removable drives, attach and boot from a USB drive." />
<meta property="og:type" content="article" />
<meta property="og:url" content="https://insecure.ucdavis.edu/archives/openbsd-4-firewall/" /><meta property="article:published_time" content="2011-12-11T09:16:54-08:00"/>
<meta property="article:modified_time" content="2011-12-11T09:16:54-08:00"/>

<meta itemprop="name" content="Openbsd 4 Firewall">
<meta itemprop="description" content="Create a boot disk for OpenBSD Install: On a Windows system:
Download ftp://ftp.openbsd.org/pub/OpenBSD/4.0/i386/cdemu40.iso for a bootable cd image. OR
Download ftp://ftp.openbsd.org/pub/OpenBSD/4.0/tools/ntrw.exe Download ftp://ftp.openbsd.org/pub/OpenBSD/4.0/i386/floppy40.fs for IDE install, floppyB40.fs for SCSI install and floppyC40.fs for laptop install. Insert a blank floppy and from the command prompt type:
ntrw floppy40.fs a:  Install OpenBSD: Insert CD/floppy in machine on which you want to install OpenBSD and boot system from the disk. If you&rsquo;re using a system with no removable drives, attach and boot from a USB drive.">


<meta itemprop="datePublished" content="2011-12-11T09:16:54-08:00" />
<meta itemprop="dateModified" content="2011-12-11T09:16:54-08:00" />
<meta itemprop="wordCount" content="2568">



<meta itemprop="keywords" content="" />
<meta name="twitter:card" content="summary"/>
<meta name="twitter:title" content="Openbsd 4 Firewall"/>
<meta name="twitter:description" content="Create a boot disk for OpenBSD Install: On a Windows system:
Download ftp://ftp.openbsd.org/pub/OpenBSD/4.0/i386/cdemu40.iso for a bootable cd image. OR
Download ftp://ftp.openbsd.org/pub/OpenBSD/4.0/tools/ntrw.exe Download ftp://ftp.openbsd.org/pub/OpenBSD/4.0/i386/floppy40.fs for IDE install, floppyB40.fs for SCSI install and floppyC40.fs for laptop install. Insert a blank floppy and from the command prompt type:
ntrw floppy40.fs a:  Install OpenBSD: Insert CD/floppy in machine on which you want to install OpenBSD and boot system from the disk. If you&rsquo;re using a system with no removable drives, attach and boot from a USB drive."/>

  </head>

  <body class="ma0 avenir bg-near-white">

    
   
  

  <header>
    <div class="bg-black">
      <nav class="pv3 ph3 ph4-ns" role="navigation">
  <div class="flex-l justify-between items-center center">
    <a href="https://insecure.ucdavis.edu" class="f3 fw2 hover-white no-underline white-90 dib">
      Insecure@UC Davis
    </a>
    <div class="flex-l items-center">
      
        <ul class="pl0 mr3">
          
          <li class="list f5 f4-ns fw4 dib pr3">
            <a class="hover-white no-underline white-90" href="/about/" title="About page">
              About
            </a>
          </li>
          
          <li class="list f5 f4-ns fw4 dib pr3">
            <a class="hover-white no-underline white-90" href="/archives/" title="Archives page">
              Archives
            </a>
          </li>
          
          <li class="list f5 f4-ns fw4 dib pr3">
            <a class="hover-white no-underline white-90" href="/posts/" title="Posts page">
              Posts
            </a>
          </li>
          
        </ul>
      
      
<div hidden>
  <span id="new-window-0">Opens in a new window</span>
  <span id="new-window-1">Opens an external site</span>
  <span id="new-window-2">Opens an external site in a new window</span>
</div>









    </div>
  </div>
</nav>

    </div>
  </header>



    <main class="pb7" role="main">
      
  
  <article class="flex-l flex-wrap justify-between mw8 center ph3 ph0-l">

    <header class="mt4 w-100">
      <p class="f6 b helvetica tracked">
          
        ARCHIVES
      </p>
      <h1 class="f1 athelas mb1">Openbsd 4 Firewall</h1>
      
      <time class="f6 mv4 dib tracked" datetime="2011-12-11T09:16:54-08:00">December 11, 2011</time>      
      
      
        <span class="f6 mv4 dib tracked"> - 13 minutes read</span>
        <span class="f6 mv4 dib tracked"> - 2568 words</span>
      
    </header>

    <main class="nested-copy-line-height lh-copy serif f4 nested-links nested-img mid-gray pr4-l w-two-thirds-l">

<h2 id="create-a-boot-disk-for-openbsd-install">Create a boot disk for OpenBSD Install:</h2>

<p>On a Windows system:</p>

<p>Download <a href="ftp://ftp.openbsd.org/pub/OpenBSD/4.0/i386/cdemu40.iso">ftp://ftp.openbsd.org/pub/OpenBSD/4.0/i386/cdemu40.iso</a> for a bootable cd image.
OR</p>

<p>Download <a href="ftp://ftp.openbsd.org/pub/OpenBSD/4.0/tools/ntrw.exe">ftp://ftp.openbsd.org/pub/OpenBSD/4.0/tools/ntrw.exe</a>
Download <a href="ftp://ftp.openbsd.org/pub/OpenBSD/4.0/i386/floppy40.fs">ftp://ftp.openbsd.org/pub/OpenBSD/4.0/i386/floppy40.fs</a> for IDE install, floppyB40.fs for SCSI install and floppyC40.fs for laptop install.
Insert a blank floppy and from the command prompt type:</p>

<pre><code>ntrw floppy40.fs a:
</code></pre>

<h2 id="install-openbsd">Install OpenBSD:</h2>

<p>Insert CD/floppy in machine on which you want to install OpenBSD and boot system from the disk. If you&rsquo;re using a system with no removable drives, attach and boot from a USB drive.</p>

<p>The following is an abbreviated list of prompts and responses:</p>

<pre><code>(I)nstall, (U)pgrade or (S)hell? i
Terminal type [vt220] &lt;return&gt;
kbd(8) mapping? ('L' for list) [none] &lt;return&gt;
Do you wish to select a keyboard encoding table? [n] &lt;return&gt;
Proceed with install? [no] y
Which one is the root disk? (or ‘done’) [wd0] &lt;return&gt;
Do you want to use *all* of wd0 for OpenBSD? [no] y
Initial label editor (enter '?' for help at any prompt)
&gt; p
&gt; d a
&gt; d b
</code></pre>

<h2 id="partitioning-information">Partitioning Information</h2>

<p>The configuration below creates a 512MB swap file, and utilizes the rest of the disk for a single partition for OpenBSD files and storage of new files. Below it is a recommendation for partitioning a 2GB flash card for use with a Lex Twister or similar compact flash based system. We partition it in this way so that we can mount most of the partitions as read-only and preserve the life of the flash card as long as possible.</p>

<p>For a hard drive, use this:</p>

<pre><code>&gt; a b
offset: [63] &lt;return&gt;
size: [78172227] 512M
FS type: [swap] &lt;return&gt;
&gt; a a
offset: [917280] &lt;return&gt;
size: [77255010] &lt;return&gt;
FS type [4.2BSD] &lt;return&gt;
mount point: [none] /
&gt; w
&gt; q
</code></pre>

<p>For a 2 GB CF Card, use this:</p>

<pre><code>&gt; a a
offset: [] &lt;return&gt;
size: [] 64M
FS type [4.2BSD] &lt;return&gt;
mount point: [none] /
&gt; a b
offset: [] &lt;return&gt;
size: [] 2M
FS type [swap] &lt;return&gt;
&gt; a d
offset: [] &lt;return&gt;
size: [] 64M
FS type [4.2BSD] &lt;return&gt;
mount point: [none] /var
&gt; a e
offset: [] &lt;return&gt;
size: [] &lt;return&gt;
FS type [4.2BSD] &lt;return&gt;
mount point: [none] /usr
&gt; w
&gt; q
</code></pre>

<p>This will give you swap = 2M, / = 64M, /var = 64M, and /usr = the rest (~1.8G).</p>

<p>Continuing on in the setup:</p>

<pre><code>Are you really sure that you're ready to proceed? [n] y
System hostname (short form, e.g. 'foo'): [] gatekeeper1
Configure the network? [y] &lt;return&gt;
Which one do you wish to initialize? (or ‘done’) [ext0] &lt;return&gt;
Symbolic (host) name for ext0? [gatekeeper1] &lt;return&gt;
Do you want to change the media options? [n] &lt;return&gt;
IPv4 address for ext0? (or 'none' or 'dhcp') 169.237.abc.d
Netmask? [255.255.255.0] &lt;enter&gt;
IPv6 address for ext0? (or 'rtsol' or 'none') [none] &lt;return&gt;
Which one to you wish to initialize? (or ‘done’) [int1] done

DNS domain name (e.g. 'bar.com'): [my.domain] ucdavis.edu
DNS nameserver? (IP address or ‘none’) [none] 169.237.1.250 169.237.250.250
Use the nameserver now? [yes] &lt;return&gt;
Default IPv4 route? (IPv4 address, ‘dhcp’ or ‘none’) 169.237.abc.254
Edit hosts with ed? [n] &lt;return&gt;
Do you want to do any manual network configuration? [n] &lt;return&gt;
Password for root account? (will not echo): *******
Password for root account? (again): *******

Location of sets? (cd disk ftp http or ‘done’) [cd] ftp
HTTP/FTP proxy URL? (e.g. 'http://proxy:8080', or 'none') [none] &lt;return&gt;
Display a list of known ftp servers? [y] &lt;return&gt;
Server IP address, hostname, or list#? [] 63
Server IP address, hostname, or list#? [ftp3.usa.openbsd.org]
openbsd.engr.ucdavis.edu OR &lt;return&gt;
Does the server support passive mode ftp? [y] &lt;return&gt;
Server directory [pub/OpenBSD/4.0/i386] &lt;return&gt;
Login? [anonymous] &lt;return&gt;
File name? (or ‘done’) [bsd.rd] -g*
File name? (or ‘done’) [bsd.rd] done
Ready to install sets? [yes] &lt;return&gt;
Location of sets? (cd disk ftp http or ‘done’) [cd] done

Start sshd(8) by default? [yes] &lt;return&gt;
Start ntpd(8) by default? [no] y
Do you expect to run the X Window System? [no] &lt;return&gt;
Change the default console to com0? [no] &lt;return&gt;
What time zone are you in? ('?' for list) [Canada/Mountain] US/Pacific

CONGRATULATIONS! Yada yada.
# reboot
</code></pre>

<p>If installing from boot disk you should remove your disk before the system reboots.</p>

<p>Login to your new installation:</p>

<pre><code>Login: root
Password: *******
Terminal type? [vt220] &lt;return&gt;
</code></pre>

<p>Create non-root account with sudo privileges:</p>

<pre><code># adduser

Couldn't find /etc/adduser.conf: creating a new adduser configuration file
Reading /etc/shells
Enter your default shell: csh ksh nologin sh [sh]: ksh
Your default shell is: ksh -&gt; /bin/ksh
Reading /etc/login.conf
Default login class: auth-defaults auth-ftp-defaults daemon default staff [default]:
Enter your default HOME partition: [/home]:
Copy dotfiles from: /etc/skel no [/etc/skel]:
Send message from file: /etc/adduser.message no [no]:
Do not send message
Prompt for passwords by default (y/n) [y]:
Default encryption method for passwords: auto blowfish des md5 old [auto]:
Use option ``-silent'' if you don't want to see all warnings and questions.

Reading /etc/shells
Check /etc/master.passwd
Check /etc/group

Ok, let's go.
Don't worry about mistakes. I will give you the chance later to correct any input.
Enter username []: adam
Enter full name []: Adam Getchell
Enter shell csh ksh nologin sh [ksh]:
Uid [1001]:
Login group adam [adam]: wheel
Login group is ``wheel''. Invite adam into other groups: guest no [no]:
Login class daemon default staff [default]:
Enter password []:
Enter password again []:

Name:adam
Password:****
Fullname:Adam Getchell
Uid: 1001
Gid: 0 (wheel)
Groups:wheel
Login Class: default
HOME:/home/adam
Shell: /bin/ksh
OK? (y/n) [y]: y
Added user ``adam''
Copy files from /etc/skel to /home/adam
Add another user? (y/n) [y]: n
Goodbye!
</code></pre>

<p>Uncomment the following line in /etc/sudoers:</p>

<pre><code>%wheel ALL=(ALL) ALL
</code></pre>

<p>User &lsquo;adam&rsquo; has sudo privileges because he&rsquo;s in the group &ldquo;wheel&rdquo;.</p>

<p>Add Useful Utilities:</p>

<pre><code># pkg_add -v ftp://ftp.openbsd.org/pub/OpenBSD/4.0/packages/i386/pftop-0.5.tgz
# pkg_add -v ftp://ftp.openbsd.org/pub/OpenBSD/4.0/packages/i386/pico-4.10.tgz
# pkg_add -v ftp://ftp.openbsd.org/pub/OpenBSD/4.0/packages/i386/cvsup-16.1h-no_x11.tgz
# pkg_add -v ftp://ftp.openbsd.org/pub/OpenBSD/4.0/packages/i386/rsync-2.6.8.tgz
</code></pre>

<p>Let&rsquo;s ban root from logging in via SSH:</p>

<pre><code># cd /etc/ssh
# cp sshd_config sshd_config.old
# vi sshd_config
</code></pre>

<p>Change the following line:</p>

<pre><code>PermitRootLogin no
</code></pre>

<p>Remove unnecessary cron jobs:</p>

<pre><code># sudo crontab -e
</code></pre>

<p>Comment out this line:</p>

<pre><code>#*/30     *     *     *     *     /usr/sbin/sendmail -L sm-map-queue -Ac -q
</code></pre>

<p>Add this line:</p>

<pre><code>ROOTBACKUP=0
</code></pre>

<p>under the line:</p>

<pre><code>HOME=/var/log
</code></pre>

<p>Turn on soft dependencies in fstab:</p>

<p>Add &ldquo;softdep&rdquo; to all lines in /etc/fstab (except swap, if any)
e.g. &ldquo;/dev/wd0a / ffs rw,noatime,softdep 1 1&rdquo;</p>

<p>If you&rsquo;re configuring a Lex Twister (CF system) follow these instructions. If not, skip to &ldquo;Update and compile&rdquo;</p>

<h2 id="configuring-the-lex-twister-for-nearly-read-only-compact-flash-media">Configuring the Lex Twister for (nearly) read-only Compact Flash media</h2>

<p>Mount /usr read-only:</p>

<pre><code># sudo cp /etc/fstab /etc/fstab.old
# sudo vi /etc/fstab
</code></pre>

<p>Change the line containing /usr to:</p>

<pre><code>/dev/wd0e /usr ffs ro,nodev,softdep 1 2
# sudo reboot
</code></pre>

<p>After rebooting, configure mfs partitions in /etc/fstab:</p>

<pre><code># sudo vi /etc/fstab
</code></pre>

<p>Add these lines:</p>

<pre><code>swap /tmp mfs rw,-s=65536,nodev,noatime,noexec,nosuid 0 0
swap /var/log mfs rw,-s=131072,nodev,noatime,noexec,nosuid 0 0
swap /var/run mfs rw,-s=2048,nodev,noatime,noexec,nosuid 0 0
swap /var/tmp mfs rw,-s=16384,nodev,noatime,noexec,nosuid 0 0
</code></pre>

<p>Now we want to persist /var/log across reboots:</p>

<pre><code># sudo mkdir -p /mfs/var.log
# sudo rm /var/log/*.gz
# sudo /usr/local/bin/rsync -vorpug /var/log/ /mfs/var.log
building file list ... done
adduser
authlog
daemon
failedlogin
ftpd
lastlog
lpd-errs
maillog
messages
pflog
secure
sendmail.st
wtmp
xferlog
wrote 328127 bytes  read 244 bytes  93820.29 bytes/sec
total size is 327215  speedup is 1.00

# sudo cp /etc/rc /etc/rc.old
# sudo vi /etc/rc
</code></pre>

<p>Add just after &ldquo;mount /var &gt;/dev/null 2&gt;&amp;1:</p>

<pre><code># Fill /var/log directory
printf &quot;copying files to mfs ...&quot;
/usr/local/bin/rsync -orpug /mfs/var.log/ /var/log
echo &quot; done.&quot;

# sudo reboot
</code></pre>

<p>Now /var/log is in memory. We need to copy it to disk during shutdown, using /etc/rc.shutdown:</p>

<pre><code># sudo cp /etc/rc.shutdown /etc/rc.shutdown.old
# sudo vi /etc/rc.shutdown
</code></pre>

<p>Append these lines:</p>

<pre><code># Save /var/log directory
printf &quot;Copying /var/log to CF ...&quot;
# ReMount / read-write now
mount -uw /dev/wd0a /
/usr/local/bin/rsync -orpug --delete /var/log/ /mfs/var.log
echo &quot; done.&quot;

# sudo reboot
</code></pre>

<p>Now we&rsquo;re going to setup the device files in /dev:</p>

<pre><code># sudo mkdir /mfs/dev
# sudo cp /dev/MAKEDEV /mfs/dev
# cd /mfs/dev
# sudo ./MAKEDEV all
# sudo mkdir -p /mfs/var.db
</code></pre>

<p>Edit /etc/fstab so that it looks like this:</p>

<pre><code>/dev/wd0a / ffs ro,noatime,softdep 1 1
/dev/wd0e /usr ffs ro,nodev,noatime,softdep 1 2
/dev/wd0d /var ffs rw,nodev,noatime,nosuid,softdep 1 2
swap /tmp mfs rw,-s=65536,nodev,noatime,noexec,nosuid 0 0
swap /var/log mfs rw,-s=131072,nodev,noatime,noexec,nosuid 0 0
swap /var/run mfs rw,-s=2048,nodev,noatime,noexec,nosuid 0 0
swap /var/tmp mfs rw,-s=16384,nodev,noatime,noexec,nosuid 0 0
swap /dev mfs rw,-s=16384,nosuid 0 0
swap /var/db mfs rw,-s=65536,nodev,noatime,noexec,nosuid 0 0
</code></pre>

<p>Now we edit /etc/rc appropriately by editing near the rm -f fastboot line:</p>

<pre><code>#mount -uw /# root on nfs requires this, others aren't hurt
rm -f /fastboot # XXX (root now writeable)
# Copy dev files before anything else
cp -Rp /mfs/dev/* /dev
# Remount / read-only
mount -ur /dev/wd0a /
</code></pre>

<p>And then at our normal spot:</p>

<pre><code>mount /var &gt;/dev/null 2&gt;&amp;1
# Fill /var/log directory
printf &quot;copying files to mfs ...&quot;
/usr/local/bin/rsync -orpug /mfs/var.log/ /var/log
/usr/local/bin/rsync -orpug /mfs/var.db/ /var/db
echo &quot; done.&quot;
</code></pre>

<p>So we&rsquo;ve done three things:</p>

<ul>
<li>prevented / from mounting writeable by commenting out `<code>#mount -uw</code></li>
<li>copied our device files</li>
<li>copied our <code>/var/db</code> files.</li>
</ul>

<p>Now we need to reboot to let <code>/var/db</code> get copied to <code>/mfs/var.db</code></p>

<p>Now let&rsquo;s go edit <code>rc.shutdown</code> to ensure our <code>/var/db</code> files get written:</p>

<pre><code># Save /var/log directory
printf &quot;Copying /var/log /var/db to CF ...&quot;
# Remount / read-write now
mount -uw /dev/wd0a /
/usr/local/bin/rsync -orpug --delete /var/log/ /mfs/var.log
/usr/local/bin/rsync -orpug --delete /var/db/ /mfs/var.db
echo &quot; done.&quot;
</code></pre>

<p>Now when we want to save this file, we get Read-only filesystem! What to do?</p>

<p>Control-Z to suspend vi:</p>

<pre><code>[1] + Stopped            sudo vi /etc/rc.shutdown
# sudo mount -uw /
# fg
</code></pre>

<p>Now save the file using <code>:wq!</code></p>

<p>To verify this works, let&rsquo;s look at the contents of <code>/var/db</code></p>

<pre><code># ls
  host.random     libc.tags       ns
  kvm_bsd.db      locate.database pkg
</code></pre>

<p>Now we&rsquo;ll reboot and see if everything is kosher:</p>

<pre><code># cd /var/db
# ls
host.random libc.tags ns
kvm_bsd.dblocate.database pkg
# pkg_info -a
pftop-0.5 curses-based real time state and rule display for pf
rsync-2.6.8 mirroring/synchronization over low bandwidth links
</code></pre>

<h2 id="update-and-compile-current-openbsd-source-code">Update and compile current OpenBSD source code</h2>

<p>There&rsquo;s not enough space on the 2GB flash card for this section!
Create a CVS update configuration file (using vi, pico, or your favorite editor):</p>

<pre><code>#vi /etc/cvs-supfile

-----------------------BEGIN-(don't include this line)-----
*default release=cvs
*default base=/usr/src
*default prefix=/usr
*default host=cvsup.usa.openbsd.org
*default delete use-rel-suffix
*default umask=002
OpenBSD-src tag=OPENBSD_4_0
OpenBSD-ports tag=OPENBSD_4_0
------------------------END-(don't include this line)------
</code></pre>

<p>Get current (stable) source code:</p>

<pre><code># /usr/local/bin/cvsup /etc/cvs-supfile
</code></pre>

<p>Skip the following line if this is your first compilation. Otherwise, make sure <code>/usr/obj</code> exists:</p>

<pre><code># rm -rf /usr/obj/*
</code></pre>

<p>Build the OpenBSD kernel (this may take several minutes):</p>

<pre><code># cd /usr/src
# make obj
# cd /usr/src/etc &amp;&amp; make DESTDIR=/ distrib-dirs
# cd /usr/src/sys/arch/i386/conf (/usr/src/sys/arch/amd64/conf)
</code></pre>

<p>For single processor boxes:</p>

<pre><code># config GENERIC
# cd ../compile/GENERIC
</code></pre>

<p>For multi-processor boxes:</p>

<pre><code># config GENERIC.MP
# cd ../compile/GENERIC.MP
</code></pre>

<p>Compile and install new kernel:</p>

<pre><code># make clean &amp;&amp; make depend &amp;&amp; make
# cp /bsd /bsd.old &amp;&amp; cp bsd /bsd
# reboot
</code></pre>

<p>Build OpenBSD userland (this may take hours):</p>

<pre><code># cd /usr/src
# make build
# reboot
</code></pre>

<h2 id="enable-ip-forwarding">Enable ip forwarding:</h2>

<p>Edit /etc/sysctl.conf and uncomment (remove the #) from the line that reads:</p>

<pre><code>net.inet.ip.forwarding=1
</code></pre>

<h2 id="turn-on-pf">Turn on PF:</h2>

<p>To turn packet filtering on create a new file /etc/rc.conf.local and enter the following (favorite editor again):</p>

<pre><code>/etc/rc.conf.local

  -----------------------BEGIN--------------------------------
  ntpd_flags=             # enabled during install
  pf=YES                  # Turn on pf
  inetd=NO                # Turn off inetd
  ftpproxy_flags=&quot;&quot;       # FTP-Proxy for Active FTP
  ------------------------END---------------------------------

  # reboot
</code></pre>

<h2 id="configure-rules-for-pf">Configure rules for pf:</h2>

<p>Write your rules and save them in pf.test</p>

<p>To test your rules type:</p>

<pre><code># pfctl -nf /etc/pf.test
</code></pre>

<p>When you are confident that you want to apply the rules type:</p>

<pre><code># cp pf.conf pf.old &amp;&amp; cp pf.test pf.conf
</code></pre>

<p>To load your rules type:</p>

<pre><code># pfctl -f /etc/pf.conf
</code></pre>

<p>Choose the mode your firewall will run in:</p>

<ul>
<li>Bridging: Transparently filters packets, no DNS resolution of addresses. No IP address.</li>
<li>VLAN Routing: Routes packets between networks. Typical setup for departmental VLAN firewall.</li>
</ul>

<h2 id="configure-openbsd-as-a-transparent-bridge">Configure OpenBSD as a transparent bridge:</h2>

<p>Assuming your NICs are ext0 and int1 type the following:</p>

<pre><code># ifconfig ext0 delete
</code></pre>

<p>If you configured the second NIC type:</p>

<pre><code># ifconfig int1 delete
# echo 'up' &gt; /etc/hostname.ext0
# echo 'up' &gt; /etc/hostname.int1
</code></pre>

<p>Now configure bridging across interfaces:</p>

<pre><code># echo 'add ext0 add int1 up' &gt; /etc/bridgename.bridge0
# reboot
</code></pre>

<p>Verify that the bridge is running by typing:</p>

<pre><code># ifconfig -a
</code></pre>

<p>You&rsquo;ll see a lot of output but you will know your bridge is working if you see the following line:</p>

<pre><code>bridge0: flags=41 &lt;UP,RUNNING&gt; mtu 1500
</code></pre>

<h2 id="configure-openbsd-as-a-routing-firewall-for-a-vlan">Configure OpenBSD as a routing firewall for a VLAN:</h2>

<p>In order to firewall your VLAN using a routing firewall, you&rsquo;ll need to first get a subnet configured by the NOC to run all of your VLAN traffic through two NAMs. You&rsquo;ll connect both NAMs to the routing firewall. One will be the external interface and will have a new subnet and subnet mask. The other will be the internal interface and will be configured as the gateway for your current subnet.</p>

<p>The following section assumes the following:</p>

<ol>
<li>The public side of your firewall sits on subnet 169.237.efg.0/24 and the mask for that subnet is 255.255.255.0.</li>
<li>The NIC on the public side of the firewall will have the ip address 169.237.efg.hij</li>
<li>The up-level router in subnet 169.237.efg.0 has IP address 169.237.efg.klm.</li>
<li>The clients on the private side of your subnet use 169.237.abc.254 as their gateway.</li>
<li>The NICs on your firewall are ext0 and int1. Type &lsquo;ifconfig -a&rsquo; to find out their real names.</li>
</ol>

<p>Try Paul Waterstraat&rsquo;s VLAN routing firewall configuration tool <a href="http://computing.geology.ucdavis.edu/security/openbsd_routing_firewall-worksheet.php">here</a></p>

<p>Start out by deleting the external interface:</p>

<pre><code># ifconfig ext0 delete
</code></pre>

<p>If you configured the second NIC delete it as well:</p>

<pre><code># ifconfig int1 delete
</code></pre>

<p>This is the IP in the new subnet NOC gave you:</p>

<pre><code># echo 'inet 169.237.efg.hij 255.255.255.252 NONE' &gt; /etc/hostname.ext0
</code></pre>

<p>This is in your current subnet. This address will be the gateway for your clients:</p>

<pre><code># echo 'inet 169.237.abc.254 255.255.255.0 NONE' &gt; /etc/hostname.int1
</code></pre>

<p>This is the gateway for your OpenBSD router. It&rsquo;s a NOC router on the same subnet as ext0&rsquo;s ip address:</p>

<pre><code># echo '169.237.efg.klm ' &gt; /etc/mygate
</code></pre>

<p>After rebooting your computer will begin using the IP addresses configured above. To avoid conflicting addresses you should either turn off other computers with these IP addresses or you should unplug this firewall from the network.</p>

<p>Reboot:</p>

<pre><code># reboot
</code></pre>

<h2 id="useful-openbsd-commands">Useful OpenBSD Commands:</h2>

<p>To show how many states are running concurrently and other useful information type (press right arrow to toggle modes):</p>

<pre><code># /usr/local/sbin/pftop
</code></pre>

<p>To mount the root filesystem as read-write type:</p>

<pre><code># mount -uw /
</code></pre>

<p>To mount the root filesystem as read-only type:</p>

<pre><code># mount -urf /
</code></pre>

<p>To see logged packets scroll on the screen type:</p>

<pre><code># tcpdump -n -e -ttt -i pflog0
</code></pre>

<p>To see logged packets scroll on the screen for a single host type:</p>

<pre><code># tcpdump -n -e -ttt -i pflog0 host &lt;hostname or ip&gt;
</code></pre>

<p>To show the amount of free disk space type:</p>

<pre><code># df -h
</code></pre>

<p>To show the amount of CPU utilization type:</p>

<pre><code># top
</code></pre>

<p>To mount a floppy type:</p>

<pre><code># mount -t msdos /dev/fd0a /mnt
</code></pre>

<p>To mount a USB flash drive type (typical):</p>

<pre><code># mount -t msdos /dev/sd0i /mnt
</code></pre>

<p>To copy a file to floppy type:</p>

<pre><code># cp &lt;filename&gt; /mnt
</code></pre>

<p>To unmount a drive mounted to /mnt type (Make sure your current directory isn&rsquo;t /mnt or a subfolder when you do this or it won&rsquo;t unmount.):</p>

<pre><code># umount /mnt
</code></pre>

<p>To display your current default directory type:</p>

<pre><code># pwd
</code></pre>

<p>To clear the display type:</p>

<pre><code># clear
</code></pre>

<p>To change your password type:</p>

<pre><code># passwd
</code></pre>

<p>To change another user&rsquo;s password type:</p>

<pre><code># sudo passwd username
</code></pre>

<p><code>Ctrl-Z</code> pushes the current job into the background and <code>fg</code> to return it to the foreground.</p>

<p><code>Ctrl-C</code> kills the job running in the foreground.</p>

<p>Setting up ftp-proxy: Instructions available here: <a href="http://www.bgnett.no/~peter/pf/en/newftpproxy.html">http://www.bgnett.no/~peter/pf/en/newftpproxy.html</a></p>
<ul class="pa0">
  
</ul>
<div class="mt6">
        
      </div>
    </main>

    <aside class="w-30-l mt6-l">




</aside>

  </article>

    </main>
    <footer class="bg-black bottom-0 w-100 pa3" role="contentinfo">
  <div class="flex justify-between">
  <a class="f4 fw4 hover-white no-underline white-70 dn dib-ns pv2 ph3" href="https://insecure.ucdavis.edu" >
    &copy; 2018 Insecure@UC Davis
  </a>
    <div>
<div hidden>
  <span id="new-window-0">Opens in a new window</span>
  <span id="new-window-1">Opens an external site</span>
  <span id="new-window-2">Opens an external site in a new window</span>
</div>








</div>
  </div>
</footer>

    

  <script src="/dist/js/app.3fc0f988d21662902933.js"></script>


  </body>
</html>
