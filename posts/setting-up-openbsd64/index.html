<!DOCTYPE html>
<html lang="en-us">
  <head>
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1">
    
    <title>Insecure@UC Davis  | Setting Up OpenBSD 6.4</title>
    <meta name="HandheldFriendly" content="True">
    <meta name="MobileOptimized" content="320">

    <meta name="viewport" content="width=device-width,minimum-scale=1">
    <meta name="generator" content="Hugo 0.53" />
    
    
      <META NAME="ROBOTS" CONTENT="NOINDEX, NOFOLLOW">
    

    
    
      <link href="/dist/css/app.955516233bcafa4d2a1c13cea63c7b50.css" rel="stylesheet">
    

    

    
      
    

    

    <meta property="og:title" content="Setting Up OpenBSD 6.4" />
<meta property="og:description" content="Prerequisites First, setup a USB install key:
Windows Rufus
MacOS Etcher
brew install balenaetcher  Note: If you aren&rsquo;t familiar with Homebrew, definitely familiarize yourself with it!
Initial install Boot from USB, changing boot order as needed. You should see a screen like the following:
  OpenBSD 6.4 Setup screen
  Pick the closest mirror to you to get the files. (I picked Sonic.net). The installation is the usual guided screens, you can safely use the defaults." />
<meta property="og:type" content="article" />
<meta property="og:url" content="https://insecure.ucdavis.edu/posts/setting-up-openbsd64/" /><meta property="article:published_time" content="2019-01-15T14:50:45-08:00"/>
<meta property="article:modified_time" content="2019-01-15T14:50:45-08:00"/>

<meta itemprop="name" content="Setting Up OpenBSD 6.4">
<meta itemprop="description" content="Prerequisites First, setup a USB install key:
Windows Rufus
MacOS Etcher
brew install balenaetcher  Note: If you aren&rsquo;t familiar with Homebrew, definitely familiarize yourself with it!
Initial install Boot from USB, changing boot order as needed. You should see a screen like the following:
  OpenBSD 6.4 Setup screen
  Pick the closest mirror to you to get the files. (I picked Sonic.net). The installation is the usual guided screens, you can safely use the defaults.">


<meta itemprop="datePublished" content="2019-01-15T14:50:45-08:00" />
<meta itemprop="dateModified" content="2019-01-15T14:50:45-08:00" />
<meta itemprop="wordCount" content="707">



<meta itemprop="keywords" content="" />
<meta name="twitter:card" content="summary"/>
<meta name="twitter:title" content="Setting Up OpenBSD 6.4"/>
<meta name="twitter:description" content="Prerequisites First, setup a USB install key:
Windows Rufus
MacOS Etcher
brew install balenaetcher  Note: If you aren&rsquo;t familiar with Homebrew, definitely familiarize yourself with it!
Initial install Boot from USB, changing boot order as needed. You should see a screen like the following:
  OpenBSD 6.4 Setup screen
  Pick the closest mirror to you to get the files. (I picked Sonic.net). The installation is the usual guided screens, you can safely use the defaults."/>

  </head>

  <body class="ma0 avenir bg-near-white">

    
   
  

  <header>
    <div class="bg-black">
      <nav class="pv3 ph3 ph4-ns" role="navigation">
  <div class="flex-l justify-between items-center center">
    <a href="https://insecure.ucdavis.edu" class="f3 fw2 hover-white no-underline white-90 dib">
      Insecure@UC Davis
    </a>
    <div class="flex-l items-center">
      
        <ul class="pl0 mr3">
          
          <li class="list f5 f4-ns fw4 dib pr3">
            <a class="hover-white no-underline white-90" href="/about/" title="About page">
              About
            </a>
          </li>
          
          <li class="list f5 f4-ns fw4 dib pr3">
            <a class="hover-white no-underline white-90" href="/archives/" title="Archives page">
              Archives
            </a>
          </li>
          
          <li class="list f5 f4-ns fw4 dib pr3">
            <a class="hover-white no-underline white-90" href="/posts/" title="Posts page">
              Posts
            </a>
          </li>
          
        </ul>
      
      
<div hidden>
  <span id="new-window-0">Opens in a new window</span>
  <span id="new-window-1">Opens an external site</span>
  <span id="new-window-2">Opens an external site in a new window</span>
</div>









    </div>
  </div>
</nav>

    </div>
  </header>



    <main class="pb7" role="main">
      
  
  <article class="flex-l flex-wrap justify-between mw8 center ph3 ph0-l">

    <header class="mt4 w-100">
      <p class="f6 b helvetica tracked">
          
        POSTS
      </p>
      <h1 class="f1 athelas mb1">Setting Up OpenBSD 6.4</h1>
      
      <time class="f6 mv4 dib tracked" datetime="2019-01-15T14:50:45-08:00">January 15, 2019</time>      
      
      
        <span class="f6 mv4 dib tracked"> - 4 minutes read</span>
        <span class="f6 mv4 dib tracked"> - 707 words</span>
      
    </header>

    <main class="nested-copy-line-height lh-copy serif f4 nested-links nested-img mid-gray pr4-l w-two-thirds-l">

<h2 id="prerequisites">Prerequisites</h2>

<p>First, setup a USB install key:</p>

<h3 id="windows">Windows</h3>

<p><a href="https://rufus.ie/en_IE.html">Rufus</a></p>

<h3 id="macos">MacOS</h3>

<p><a href="https://www.balena.io/etcher/">Etcher</a></p>

<pre><code>brew install balenaetcher
</code></pre>

<p>Note: If you aren&rsquo;t familiar with <a href="https://brew.sh">Homebrew</a>, definitely familiarize yourself
with it!</p>

<h2 id="initial-install">Initial install</h2>

<p>Boot from USB, changing boot order as needed. You should see a screen like
the following:</p>

<figure>
    <img src="/images/setup.png"
         alt="OpenBSD 6.4 Setup screen"/> <figcaption>
            <p>OpenBSD 6.4 Setup screen</p>
        </figcaption>
</figure>


<p>Pick the closest mirror to you to get the files. (I picked Sonic.net).
The installation is the usual guided screens, you can safely use the defaults.
I go back and forth between putting X on a firewall, I left it on because
we might want to do nice graphic libraries which will require it.</p>

<h2 id="configuration">Configuration</h2>

<p>First, setup <a href="https://man.openbsd.org/doas">doas</a> with something like the following in <code>\etc\doas.conf</code>:</p>

<pre><code>permit nopass adam as root
</code></pre>

<p>From here on out, we&rsquo;ll use <code>doas</code> for operations requiring administrative
access.</p>

<h3 id="updating-to-stable"><a href="https://www.openbsd.org/faq/faq5.html">Updating</a> to Stable</h3>

<p>We&rsquo;ll want to update our fresh OpenBSD install with the latest source from the
<code>-stable</code> branch. Do the following:</p>

<p>Add yourself to the <code>wsrc</code> group, which has write permissions to <code>/usr/src</code>.</p>

<pre><code>doas user mod -G wsrc adam
</code></pre>

<p>You&rsquo;ll have to logout and login for this to take effect.</p>

<p>Next, set permissions to enable fetching <code>ports</code> and <a href="OpenBSD's
custom X server">xenocara</a>:</p>

<pre><code>cd /usr
doas mkdir -p xenocara ports
doas chgrp wsrc xenocara ports
doas chmod 755 xenocara ports
</code></pre>

<p>Now fetch <code>-stable</code>:</p>

<pre><code>cd /usr
cvs -qd anoncvs@anoncvs1.usa.openbsd.org:/cvs checkout -rOPENBSD_6_4 -P src
</code></pre>

<p>This example is fetching from the mirror at Bend, Oregon, and will take awhile.
Use the closest mirror.</p>

<h4 id="build-and-install-a-new-kernel">Build and install a new kernel</h4>

<pre><code>cd /sys/arch/$(machine)/compile/GENERIC.MP
doas make obj
doas make config
doas make
doas make install
</code></pre>

<p>The current kernel is copied to <code>/obsd</code> and the new kernel is <code>/bsd</code>. Reboot.
If you have a kernel panic, <a href="https://man.openbsd.org/boot.8">boot</a> the old kernel and try again.</p>

<h4 id="build-and-update-a-new-base-system">Build and update a new base system</h4>

<pre><code>cd /usr/src
doas make obj
doas make build
doas sysmerge
cd /dev
doas ./MAKEDEV all
</code></pre>

<p>This will take a few hours. Building OpenBSD from source is a good hardware
burn-in test. If you are getting <a href="https://www.bitwizard.nl/sig11/">Signal 11</a> errors, your firewall hardware is
not ready for production.</p>

<h4 id="building-x">Building X</h4>

<p>Since we specified X11 packages on the initial install, we&rsquo;ll need to update
Xenocara, OpenBSD&rsquo;s meta-build for <a href="https://www.x.org/wiki/">X.Org</a>. Note that you will need at least
4GB on <code>/usr</code>!</p>

<pre><code>cd /usr
doas cvs -qd anoncvs@anoncvs1.usa.openbsd.org:/cvs checkout -rOPENBSD_6_4 -P xenocara
cd /usr/xenocara
doas make bootstrap
doas make obj
doas make build
</code></pre>

<p>This will take another couple of hours.</p>

<h2 id="configure-routing-firewall-for-a-vlan">Configure routing firewall for a VLAN:</h2>

<p>In order to protect your VLAN using a <a href="https://www.openbsd.org/faq/pf/example1.html">routing</a> firewall, you&rsquo;ll need to first get a subnet configured by the NOC to run all of your VLAN traffic through two NAMs. You&rsquo;ll connect both NAMs to the routing firewall. One will be the external interface and will have a new subnet and subnet mask. The other will be the internal interface and will be configured as the gateway for your current subnet.</p>

<p>The following section assumes the following:</p>

<ol>
<li>The public side of your firewall sits on subnet 169.237.efg.0/24 and the mask for that subnet is 255.255.255.0.</li>
<li>The NIC on the public side of the firewall will have the ip address 169.237.efg.hij</li>
<li>The up-level router in subnet 169.237.efg.0 has IP address 169.237.efg.klm.</li>
<li>The clients on the private side of your subnet use 169.237.abc.254 as their gateway.</li>
<li>The NICs on your firewall are ext0 and int1. Type &lsquo;ifconfig -a&rsquo; to find out their real names.</li>
</ol>

<p>Try Paul Waterstraat&rsquo;s VLAN routing firewall configuration tool <a href="http://computing.geology.ucdavis.edu/security/openbsd_routing_firewall-worksheet.php">here</a></p>

<p>First, configure IP forwarding:</p>

<pre><code>doas vi /etc/sysctl.conf
</code></pre>

<p>The contents of this file should be:</p>

<pre><code>net.inet.ip.forwarding=1
</code></pre>

<p>Next, delete the external interface:</p>

<pre><code># ifconfig ext0 delete
</code></pre>

<p>If you configured the second NIC delete it as well:</p>

<pre><code># ifconfig int1 delete
</code></pre>

<p>This is the IP in the new subnet NOC gave you:</p>

<pre><code># echo 'inet 169.237.efg.hij 255.255.255.252 NONE' &gt; /etc/hostname.ext0
</code></pre>

<p>This is in your current subnet. This address will be the gateway for your clients:</p>

<pre><code># echo 'inet 169.237.abc.254 255.255.255.0 NONE' &gt; /etc/hostname.int1
</code></pre>

<p>This is the gateway for your OpenBSD router. It&rsquo;s a NOC router on the same subnet as ext0&rsquo;s ip address:</p>

<pre><code># echo '169.237.efg.klm ' &gt; /etc/mygate
</code></pre>

<p>After rebooting your computer will begin using the IP addresses configured above. To avoid conflicting addresses you should either turn off other computers with these IP addresses or you should unplug this firewall from the network.</p>

<p>Reboot:</p>

<pre><code># reboot
</code></pre>
<ul class="pa0">
  
</ul>
<div class="mt6">
        
      </div>
    </main>

    <aside class="w-30-l mt6-l">




</aside>

  </article>

    </main>
    <footer class="bg-black bottom-0 w-100 pa3" role="contentinfo">
  <div class="flex justify-between">
  <a class="f4 fw4 hover-white no-underline white-70 dn dib-ns pv2 ph3" href="https://insecure.ucdavis.edu" >
    &copy; 2019 Insecure@UC Davis
  </a>
    <div>
<div hidden>
  <span id="new-window-0">Opens in a new window</span>
  <span id="new-window-1">Opens an external site</span>
  <span id="new-window-2">Opens an external site in a new window</span>
</div>








</div>
  </div>
</footer>

    

  <script src="/dist/js/app.3fc0f988d21662902933.js"></script>


  </body>
</html>
